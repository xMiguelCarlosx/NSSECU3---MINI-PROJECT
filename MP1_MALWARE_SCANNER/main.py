#!/usr/bin/env python3
"""
MP1 Malware Scanner
January 2026 - NSSECU3
Requirements: Mount (AIM), Scan (Python), List
"""
import argparse
import logging
import json
from pathlib import Path
from datetime import datetime
from colorama import init, Fore, Style

from src.scanner import MalwareScanner
from src.reporter import ScanReporter

init(autoreset=True)  # Colorama

def setup_logging(level=logging.INFO):
    """Configure logging for scanner."""
    logging.basicConfig(
        level=level,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler('scanner.log'),
            logging.StreamHandler()
        ]
    )

def main():
    parser = argparse.ArgumentParser(
        description='MP1 Malware Scanner - NSSECU3',
        epilog='Mount disk with AIM first, then scan the mounted drive letter.'
    )
    
    parser.add_argument(
        'target',
        help='Path to scan (e.g., D:\\ or /mnt/image)'
    )
    
    parser.add_argument(
        '--rules',
        default='rules/ai_combined.yar',
        help='YARA rules file (default: rules/ai_combined.yar)'
    )
    
    parser.add_argument(
        '--quarantine',
        default='./quarantine',
        help='Quarantine directory (default: ./quarantine)'
    )
    
    parser.add_argument(
        '--output',
        default=f'reports/scan_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json',
        help='Output report file'
    )
    
    parser.add_argument(
        '--threads',
        type=int,
        default=4,
        help='Number of scan threads (default: 4)'
    )
    
    parser.add_argument(
        '--ai-compare',
        action='store_true',
        help='Run AI comparison mode (scan with each AI rule set)'
    )
    
    parser.add_argument(
        '--quarantine-auto',
        action='store_true',
        help='Automatically quarantine detected malware'
    )
    
    parser.add_argument(
        '--log-level',
        default='INFO',
        choices=['DEBUG', 'INFO', 'WARNING', 'ERROR'],
        help='Set logging level'
    )
    
    args = parser.parse_args()
    
    # Setup logging
    setup_logging(getattr(logging, args.log_level))
    
    # Validate target exists
    target_path = Path(args.target)
    if not target_path.exists():
        print(Fore.RED + f"‚ùå Error: Target path does not exist: {target_path}")
        print("Did you mount the disk image with Arsenal Image Mounter?")
        return 1
    
    # Validate rules exist
    rules_path = Path(args.rules)
    if not rules_path.exists():
        print(Fore.RED + f"‚ùå Error: Rules file not found: {rules_path}")
        return 1
    
    print(Fore.CYAN + "=" * 60)
    print(Fore.CYAN + "        MP1 MALWARE SCANNER - NSSECU3")
    print(Fore.CYAN + "=" * 60)
    print(f"Target:      {target_path}")
    print(f"Rules:       {rules_path}")
    print(f"Quarantine:  {args.quarantine}")
    print(f"Threads:     {args.threads}")
    print(Fore.CYAN + "-" * 60)
    
    # Initialize scanner
    scanner = MalwareScanner(
        rules_path=rules_path,
        quarantine_path=Path(args.quarantine),
        thread_count=args.threads
    )
    
    # Run scan
    print(Fore.YELLOW + "\nüîç Scanning started...")
    results = []
    
    try:
        for result in scanner.scan_directory(
            target_path,
            recursive=True,
            auto_quarantine=args.quarantine_auto
        ):
            results.append(result)
            
            # Live console output
            status = Fore.RED + "MALICIOUS" if result.get('is_malicious') else Fore.GREEN + "CLEAN"
            file_type = result.get('file_type', {}).get('description', 'Unknown')
            print(f"[{status}] {result['filename']:<15} | {file_type:<20} | MD5: {result.get('hashes',{}).get('md5','')[:8]}...")
            
    except KeyboardInterrupt:
        print(Fore.YELLOW + "\n\n‚ö†Ô∏è Scan interrupted by user")
    
    # Generate report
    print(Fore.CYAN + "\n" + "=" * 60)
    print("üìä SCAN COMPLETE")
    print("=" * 60)
    print(f"Files scanned:     {scanner.scan_stats['files_scanned']}")
    print(f"Malicious found:   {Fore.RED}{scanner.scan_stats['malicious_found']}{Style.RESET_ALL}")
    print(f"Quarantined:       {scanner.scan_stats['quarantined']}")
    print(f"Errors:            {scanner.scan_stats['errors']}")
    print(f"Scan time:         {scanner.scan_stats['end_time']} seconds")
    
    # Save report
    report_path = Path(args.output)
    report_path.parent.mkdir(exist_ok=True)
    
    # Convert datetime objects to strings for JSON serialization
    stats_for_json = {
        'files_scanned': scanner.scan_stats['files_scanned'],
        'malicious_found': scanner.scan_stats['malicious_found'],
        'quarantined': scanner.scan_stats['quarantined'],
        'errors': scanner.scan_stats['errors'],
        'start_time': str(scanner.scan_stats['start_time']),
        'end_time': str(scanner.scan_stats['end_time'])
    }
    
    with open(report_path, 'w') as f:
        json.dump({
            'scan_metadata': {
                'target': str(target_path),
                'rules': str(rules_path),
                'timestamp': datetime.now().isoformat(),
                'stats': stats_for_json
            },
            'results': results
        }, f, indent=2)
    
    print(Fore.GREEN + f"\n‚úÖ Report saved: {report_path}")
    
    return 0

if __name__ == '__main__':
    exit(main())