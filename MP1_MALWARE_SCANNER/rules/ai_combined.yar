/*
 * YARA Rules for Common Malware Detection 
 * Author: Generated for MP1 Malware Forensics Project: ChatGPT GPT-5.2
 * Date: 2026-02-13
 * Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
 */

import "pe"
import "math"

/* =========================================================
   1. Generic PE Malware Indicators
   ========================================================= */
rule PE_Generic_Malware_Indicators
{
    meta:
        category = "pe"
        confidence = "medium"
        description = "Detects suspicious PE characteristics such as high entropy, odd sections, and packing"
        author = "ChatGPT GPT-5.2"

    strings:
        $packer1 = "UPX!" ascii
        $packer2 = "MPRESS" ascii
        $packer3 = "Themida" ascii
        $suspicious_api1 = "VirtualAlloc" ascii
        $suspicious_api2 = "WriteProcessMemory" ascii
        $suspicious_api3 = "CreateRemoteThread" ascii

    condition:
        uint16(0) == 0x5A4D and
        pe.is_pe and
        (
            any of ($packer*) or
            (
                pe.number_of_sections > 6 and
                math.entropy(pe.sections[0].raw_data_offset, pe.sections[0].raw_data_size) > 7.0
            ) or
            all of ($suspicious_api*)
        )
}

/* =========================================================
   2. PDF with JavaScript or Embedded Objects
   ========================================================= */
rule PDF_Embedded_JavaScript
{
    meta:
        category = "pdf"
        confidence = "high"
        description = "Detects PDFs with embedded JavaScript or suspicious objects"
        author = "ChatGPT GPT-5.2"

    strings:
        $pdf_magic = "%PDF-" ascii
        $js1 = "/JavaScript" ascii
        $js2 = "/JS" ascii
        $action = "/OpenAction" ascii
        $objstm = "/ObjStm" ascii
        $stream = "stream" ascii

    condition:
        $pdf_magic at 0 and
        2 of ($js1, $js2, $action, $objstm, $stream)
}

/* =========================================================
   3. Office Documents with Macros
   ========================================================= */
rule Office_Macro_Malware
{
    meta:
        category = "office"
        confidence = "high"
        description = "Detects malicious VBA macro keywords in Office documents"
        author = "ChatGPT GPT-5.2"

    strings:
        $ole_magic = { D0 CF 11 E0 A1 B1 1A E1 }
        $autoopen1 = "AutoOpen" ascii nocase
        $autoopen2 = "Document_Open" ascii nocase
        $shell = "Shell(" ascii nocase
        $powershell = "powershell" ascii nocase
        $wscript = "WScript.Shell" ascii nocase
        $base64 = "Base64Decode" ascii nocase

    condition:
        $ole_magic at 0 and
        2 of ($autoopen*, $shell, $powershell, $wscript, $base64)
}

/* =========================================================
   4. Suspicious PowerShell Commands
   ========================================================= */
rule PowerShell_Suspicious_Commands
{
    meta:
        category = "powershell"
        confidence = "high"
        description = "Detects obfuscated or malicious PowerShell behavior"
        author = "ChatGPT GPT-5.2"

    strings:
        $ps1 = "powershell" ascii nocase
        $enc = "-enc" ascii nocase
        $bypass = "ExecutionPolicy Bypass" ascii nocase
        $iex = "Invoke-Expression" ascii nocase
        $download = "DownloadString" ascii nocase
        $hidden = "-windowstyle hidden" ascii nocase

    condition:
        $ps1 and
        2 of ($enc, $bypass, $iex, $download, $hidden)
}

/* =========================================================
   5. JavaScript Malware / Backdoor Patterns
   ========================================================= */
rule JavaScript_Malware_Backdoor
{
    meta:
        category = "javascript"
        confidence = "medium"
        description = "Detects suspicious JavaScript obfuscation and backdoor-like behavior"
        author = "ChatGPT GPT-5.2"

    strings:
        $eval = "eval(" ascii nocase
        $fromchar = "String.fromCharCode" ascii nocase
        $unescape = "unescape(" ascii nocase
        $xhr = "XMLHttpRequest" ascii nocase
        $fetch = "fetch(" ascii nocase
        $c2 = "http://" ascii nocase
        $c2s = "https://" ascii nocase

    condition:
        3 of ($eval, $fromchar, $unescape, $xhr, $fetch) and
        any of ($c2*)
}

/* =========================================================
   6. Generic Backdoor / RAT Indicators
   ========================================================= */
rule Generic_Backdoor_Patterns
{
    meta:
        category = "backdoor"
        confidence = "medium"
        description = "Detects common backdoor and RAT command patterns"
        author = "ChatGPT GPT-5.2"

    strings:
        $cmd1 = "cmd.exe /c" ascii nocase
        $cmd2 = "whoami" ascii nocase
        $cmd3 = "net user" ascii nocase
        $cmd4 = "net localgroup" ascii nocase
        $persist1 = "Run\\\\" ascii nocase
        $persist2 = "CurrentVersion\\\\Run" ascii nocase

    condition:
        2 of ($cmd*) or
        any of ($persist*)
}
/*
YARA Rules for Common Malware Detection 
Author: Generated for MP1 Malware Forensics Project: DEEPSEEK
Date: 2026-02-13
Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
*/

import "pe"
import "math"

rule SUSPICIOUS_PE_HighEntropy_Sections
{
    meta:
        author = "deepseek"
        description = "Detects PE files with high entropy sections (potential packed/encrypted malware)"
        date = "2026-02-13"
        score = 85
        fileType = "PE_EXECUTABLE"
    
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and
        (
            (
                for any i in (0..pe.number_of_sections - 1) :
                    (
                        (pe.sections[i].name == ".text" or
                         pe.sections[i].name == "UPX0" or
                         pe.sections[i].name == ".aspack") and
                        pe.sections[i].raw_data_size > 0 and
                        math.entropy(
                            pe.sections[i].raw_data_offset,
                            pe.sections[i].raw_data_size
                        ) > 6.8
                    )
            )
            or
            (
                for any i in (0..pe.number_of_sections - 1) :
                    (
                        pe.sections[i].name == ".upx0" or
                        pe.sections[i].name == ".aspack" or
                        pe.sections[i].name == ".adata" or
                        pe.sections[i].name == "PACKED"
                    )
            )
            or
            (
                for any i in (0..pe.number_of_sections - 1) :
                    (
                        pe.sections[i].characteristics & pe.SECTION_MEM_WRITE and
                        pe.sections[i].characteristics & pe.SECTION_MEM_EXECUTE
                    )
            )
        ) and
        not pe.is_signed and
        pe.number_of_signatures == 0
}



rule MALICIOUS_PDF_JavaScript_Objects
{
    meta:
        author = "deepseek"
        description = "Detects PDF files containing JavaScript objects (potential malicious PDF)"
        date = "2026-02-13"
        score = 90
        fileType = "PDF_DOCUMENT"
    
    strings:
        $magic = { 25 50 44 46 }
        $js1 = "/JavaScript" nocase
        $js2 = "/JS" nocase
        $launch = "/Launch" nocase
        $embedded = "/EmbeddedFile" nocase
        $openaction = "/OpenAction" nocase
        $uri = "/URI" nocase
        
    condition:
        $magic at 0 and
        ($js1 or $js2) and
        ($launch or $embedded or $openaction or $uri) and
        filesize < 10MB
}



rule MALICIOUS_PDF_Exploit_Strings
{
    meta:
        author = "deepseek"
        description = "Detects PDF files with exploit-related strings"
        date = "2026-02-13"
        score = 85
        fileType = "PDF_DOCUMENT"
    
    strings:
        $magic = { 25 50 44 46 }
        $heapspray1 = "/UI" nocase
        $heapspray2 = "/Collab" nocase
        $collab = "/Collab.getIcon" nocase
        $util = "app.util" nocase
        $eval = "eval(" nocase ascii
        $ek1 = "/BlackHole" nocase
        $ek2 = "/Angler" nocase
        $ek3 = "/Nuclear" nocase
        $shellcode1 = { 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? E8 ?? ?? ?? ?? }
        $shellcode2 = { 31 C9 64 8B 71 30 }
        
    condition:
        $magic at 0 and
        (
            $heapspray1 or $heapspray2 or
            ($collab and $util) or
            $eval or
            $ek1 or $ek2 or $ek3 or
            $shellcode1 or $shellcode2
        )
}

rule MALICIOUS_OFFICE_Macros_VBA
{
    meta:
        author = "deepseek"
        description = "Detects Office documents with VBA macros (potential malware)"
        date = "2026-02-13"
        score = 95
        fileType = "OFFICE_DOCUMENT"
    
    strings:
        $ole_magic = { D0 CF 11 E0 A1 B1 1A E1 }
        $zip_magic = { 50 4B 03 04 }
        $vba1 = "VBA" nocase
        $vba2 = "Module=" nocase
        $shell = "Shell(" nocase ascii
        $createobject = "CreateObject(" nocase ascii
        $wscript = "WScript.Shell" nocase ascii
        $powershell = "PowerShell" nocase ascii
        $cmd = "cmd.exe" nocase ascii
        $download = "URLDownloadToFile" nocase ascii
        $xmlhttp = "XMLHTTP" nocase ascii
        $adodb = "ADODB.Stream" nocase ascii
        $auto_open = "Auto_Open" nocase ascii
        $auto_close = "Auto_Close" nocase ascii
        $document_open = "Document_Open" nocase ascii
        $workbook_open = "Workbook_Open" nocase ascii
        
    condition:
        ($ole_magic at 0 or $zip_magic at 0) and
        ($vba1 or $vba2) and
        (
            $shell or $createobject or $wscript or
            $powershell or $cmd or $download or
            $xmlhttp or $adodb
        ) and
        ($auto_open or $auto_close or $document_open or $workbook_open)
}

rule MALICIOUS_JavaScript_Obfuscated
{
    meta:
        author = "deepseek"
        description = "Detects obfuscated/deobfuscation patterns in JavaScript"
        date = "2026-02-13"
        score = 85
        fileType = "JAVASCRIPT"
    
    strings:
        $eval = "eval(" nocase ascii
        $document_write = "document.write(" nocase ascii
        $unescape = "unescape(" nocase ascii
        $decodeuri = "decodeURIComponent(" nocase ascii
        $fromcharcode = "String.fromCharCode(" nocase ascii
        $replace = ".replace(" nocase ascii
        $long_hex = /[0-9a-fA-F]{40,}/
        $long_num = /[0-9]{50,}/
        $activex = "ActiveXObject" nocase ascii
        $wscript = "WScript" nocase ascii
        $adodb = "ADODB" nocase ascii
        $xmlhttp = "XMLHttpRequest" nocase ascii
        
    condition:
        filesize < 1MB and
        (
            (
                ($eval or $document_write) and
                ($unescape or $decodeuri or $fromcharcode) and
                (#long_hex > 1 or #long_num > 1)
            ) or
            (
                ($activex or $wscript or $adodb or $xmlhttp) and
                ($eval or $unescape or $fromcharcode)
            )
        ) and
        any of ($replace)
}

rule MALICIOUS_PowerShell_Suspicious_Commands
{
    meta:
        author = "deepseek"
        description = "Detects suspicious PowerShell commands used by malware"
        date = "2026-02-13"
        score = 90
        fileType = "POWERSHELL_SCRIPT"
    
    strings:
        $ep_bypass1 = "-ExecutionPolicy Bypass" nocase ascii
        $ep_bypass2 = "Set-ExecutionPolicy" nocase ascii
        $hidden1 = "-WindowStyle Hidden" nocase ascii
        $hidden2 = "-WindowsStyle Hidden" nocase ascii
        $hidden3 = "-NoProfile" nocase ascii
        $download1 = "System.Net.WebClient" nocase ascii
        $download2 = "DownloadFile(" nocase ascii
        $download3 = "DownloadString(" nocase ascii
        $download4 = "Invoke-WebRequest" nocase ascii
        $download5 = "Invoke-RestMethod" nocase ascii
        $b64_flag1 = "-EncodedCommand" nocase ascii
        $b64_flag2 = "-enc" nocase ascii
        $reflection1 = "Add-Type" nocase ascii
        $backtick = "`" ascii
        $replace_ops = ".Replace(" nocase ascii
        
    condition:
        (
            ($ep_bypass1 or $ep_bypass2) and
            ($hidden1 or $hidden2 or $hidden3) and
            ($download1 or $download2 or $download3 or $download4 or $download5)
        ) or
        $b64_flag1 or $b64_flag2 or
        $reflection1 or
        (#backtick > 10 and $replace_ops)
}

rule MALICIOUS_Backdoor_Persistence
{
    meta:
        author = "deepseek"
        description = "Detects common backdoor persistence mechanisms"
        date = "2026-02-13"
        score = 90
        fileType = "VARIOUS"
    
    strings:
        $reg_run1 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $reg_run2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $reg_run3 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $schtasks1 = "schtasks" nocase ascii
        $schtasks2 = "/create" nocase ascii
        $schtasks3 = "/sc daily" nocase ascii
        $schtasks4 = "/sc onlogon" nocase ascii
        $startup1 = "Startup" nocase ascii
        $startup2 = "All Users\\Start Menu\\Programs\\Startup" nocase ascii
        $service1 = "CreateService" nocase ascii
        $service2 = "sc.exe create" nocase ascii
        $service3 = "New-Service" nocase ascii
        $c2_http = "http://" nocase ascii
        $c2_https = "https://" nocase ascii
        $c2_post = "POST" nocase ascii
        $c2_get = "GET" nocase ascii
        $cmd_shell = "cmd.exe /c" nocase ascii
        $ps_shell = "powershell.exe" nocase ascii
        
    condition:
        $reg_run1 or $reg_run2 or $reg_run3 or
        ($schtasks1 and ($schtasks2 or $schtasks3 or $schtasks4)) or
        $startup1 or $startup2 or
        $service1 or $service2 or $service3 or
        $c2_http or $c2_https or $c2_post or $c2_get or
        $cmd_shell or $ps_shell or
        (($c2_http or $c2_https or $c2_post or $c2_get) and
         ($reg_run1 or $reg_run2 or $schtasks1 or $startup1))
}

rule MALICIOUS_Generic_Suspicious_Strings
{
    meta:
        author = "deepseek"
        description = "Detects generic suspicious strings commonly found in malware"
        date = "2026-02-13"
        score = 70
        fileType = "VARIOUS"
    
    strings:
        $s1 = "MALWARE" nocase ascii wide
        $s2 = "BACKDOOR" nocase ascii wide
        $s3 = "RAT" nocase ascii wide
        $s4 = "DROPPER" nocase ascii wide
        $s5 = "PAYLOAD" nocase ascii wide
        $s6 = "EXPLOIT" nocase ascii wide
        $s7 = "CRYPT" nocase ascii wide
        $s8 = "INJECT" nocase ascii wide
        $s9 = "KEYLOG" nocase ascii wide
        $s10 = "PASSWORD STEALER" nocase ascii wide
        $s11 = "BYPASS" nocase ascii wide
        $s12 = "PRIVILEGE ESCALATION" nocase ascii wide
        
    condition:
        2 of ($s*)
}
/*
YARA Rules for Common Malware Detection 
Author: Generated for MP1 Malware Forensics Project: GEMINI
Date: 2026-02-13
Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
*/

import "pe"
import "math"

// ============================================================================
// 1. PE EXECUTABLES (4 Rules)
// ============================================================================

/*
 * Rule Name: SUSPICIOUS_PE_KnownPackerSections
 * Target: Windows PE Executables
 * Technique: Identification of non-standard section names used by packers/protectors
 * False Positives: Rare, as these names are specific to packing tools
 */
rule SUSPICIOUS_PE_KnownPackerSections {
    meta:
        author = "Gemini"
        description = "Detects PE files using known packer section names like UPX, ASPack, and VMProtect"
        date = "2026-02-13"
        score = 85
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        // Section names are typically 8 bytes, null-padded
        $s1 = "UPX0"
        $s2 = "UPX1"
        $s3 = ".aspack"
        $s4 = ".adata"
        $s5 = ".vmp0"
        $s6 = ".vmp1"
        $s7 = ".enigma"
        $s8 = ".petite"
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and
        any of ($s*)
}

/*
 * Rule Name: SUSPICIOUS_PE_HighEntropySections
 * Target: Windows PE Executables
 * Technique: Entropy analysis to find encrypted or compressed code/data
 * False Positives: Heavily compressed legitimate installers or game assets
 */
rule SUSPICIOUS_PE_HighEntropySections {
    meta:
        author = "Gemini"
        description = "Detects PE files with sections exceeding entropy thresholds (indicative of packing/encryption)"
        date = "2026-02-13"
        score = 80
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and pe.number_of_signatures == 0 and
        /* Iterate through sections to check entropy.
           Entropy > 7.5 is a strong indicator of encryption/packing.
        */
        for any i in (0..pe.number_of_sections - 1): (
            math.entropy(pe.sections[i].raw_data_offset, pe.sections[i].raw_data_size) > 7.5
        )
}

/*
 * Rule Name: SUSPICIOUS_PE_ProcessInjection_APIs
 * Target: Windows PE Executables
 * Technique: Core APIs used for Cross-Process Memory Injection
 * False Positives: Debuggers, Security software, specialized system utilities
 */
rule SUSPICIOUS_PE_ProcessInjection_APIs {
    meta:
        author = "Gemini"
        description = "Detects combination of APIs used to inject code into remote processes"
        date = "2026-02-13"
        score = 90
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $api1 = "VirtualAllocEx"
        $api2 = "WriteProcessMemory"
        $api3 = "CreateRemoteThread"
        $api4 = "NtCreateThreadEx"
        $api5 = "QueueUserAPC"
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and pe.number_of_signatures == 0 and
        (3 of ($api*))
}

/*
 * Rule Name: SUSPICIOUS_PE_PersistenceAndEvasion
 * Target: Windows PE Executables
 * Technique: Registry persistence combined with anti-debugging checks
 * False Positives: Monitoring tools or complex legitimate software protections
 */
rule SUSPICIOUS_PE_PersistenceAndEvasion {
    meta:
        author = "Gemini"
        description = "Detects persistence mechanisms combined with anti-forensic evasion APIs"
        date = "2026-02-13"
        score = 75
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $reg1 = "RegSetValueEx"
        $reg2 = "RegCreateKeyEx"
        $eva1 = "IsDebuggerPresent"
        $eva2 = "NtQueryInformationProcess"
        $eva3 = "CheckRemoteDebuggerPresent"
        $sch1 = "schtasks.exe" wide ascii
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and
        (
            (any of ($reg*)) or $sch1
        ) and
        (any of ($eva*)) and
        pe.number_of_signatures == 0
}


// ============================================================================
// 2. PDF DOCUMENTS (2 Rules)
// ============================================================================

/*
 * Rule Name: MALICIOUS_PDF_JavaScriptExecution
 * Target: PDF Documents
 * Technique: Automatic execution of JavaScript upon opening the document
 * False Positives: Interactive PDF forms
 */
rule MALICIOUS_PDF_JavaScriptExecution {
    meta:
        author = "Gemini"
        description = "Detects PDF files that contain both JavaScript and Auto-Open actions"
        date = "2026-02-13"
        score = 85
        fileType = "PDF_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $magic = { 25 50 44 46 } // %PDF
        $s1 = "/JavaScript"
        $s2 = "/JS"
        $s3 = "/OpenAction"
        $s4 = "/AcroForm"
    condition:
        $magic at 0 and (all of ($s1, $s2, $s3) or all of ($s2, $s3, $s4))
}

/*
 * Rule Name: MALICIOUS_PDF_EmbeddedExploit
 * Target: PDF Documents
 * Technique: Embedding malicious files or using Launch actions for execution
 * False Positives: Complex portfolio PDFs
 */
rule MALICIOUS_PDF_EmbeddedExploit {
    meta:
        author = "Gemini"
        description = "Detects high-risk PDF tags used for embedding and launching external payloads"
        date = "2026-02-13"
        score = 90
        fileType = "PDF_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $magic = { 25 50 44 46 }
        $e1 = "/EmbeddedFile"
        $e2 = "/Launch"
        $e3 = "/URI"
        $e4 = "unescape" // Often used in heap sprays within PDF JS
    condition:
        $magic at 0 and 2 of ($e*) and filesize < 10MB
}

// ============================================================================
// 3. OFFICE DOCUMENTS (2 Rules)
// ============================================================================

/*
 * Rule Name: TROJAN_Office_AutoExecMacro
 * Target: Office Documents (.doc, .xls, .docx, .xlsx)
 * Technique: VBA macros that execute automatically to run malicious commands
 * False Positives: Corporate documents with legitimate automation
 */
rule TROJAN_Office_AutoExecMacro {
    meta:
        author = "Gemini"
        description = "Detects Office documents with VBA macros that auto-execute on opening"
        date = "2026-02-13"
        score = 85
        fileType = "OFFICE_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $magic_ooxml = { 50 4B 03 04 } // ZIP-based (Docx, Xlsx)
        $magic_ole = { D0 CF 11 E0 }   // OLE-based (Doc, Xls)

        $a1 = "Auto_Open"
        $a2 = "Document_Open"
        $a3 = "Workbook_Open"

        $s1 = "WScript.Shell"
        $s2 = "CreateObject"
        $s3 = "Shell.Application"

    condition:
        ($magic_ooxml at 0 or $magic_ole at 0) and
        (any of ($a*)) and (any of ($s*))
}

/*
 * Rule Name: MALICIOUS_Office_PowerShellDownload
 * Target: Office Documents
 * Technique: VBA macro launching PowerShell to download a payload
 * False Positives: Extremely rare in legitimate business contexts
 */
rule MALICIOUS_Office_PowerShellDownload {
    meta:
        author = "Gemini"
        description = "Detects Office macros calling PowerShell with download and bypass flags"
        date = "2026-02-13"
        score = 95
        fileType = "OFFICE_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $p1 = "powershell.exe" ascii wide
        $p2 = "-ExecutionPolicy Bypass" ascii wide
        $p3 = "-WindowStyle Hidden" ascii wide
        $p4 = "URLDownloadToFile" ascii wide
        $p5 = "MSXML2.XMLHTTP" ascii wide
    condition:
        (uint32(0) == 0x04034B50 or uint32(0) == 0xE11AB1D0) and
        (any of ($p1, $p2, $p3)) and (any of ($p4, $p5))
}

// ============================================================================
// 4. JAVASCRIPT (2 Rules)
// ============================================================================

/*
 * Rule Name: OBFUSCATED_JS_EvalWithFromCharCode
 * Target: JavaScript Files
 * Technique: Use of eval and fromCharCode to hide malicious script logic
 * False Positives: Minified or protected legitimate JS libraries
 */
rule OBFUSCATED_JS_EvalWithFromCharCode {
    meta:
        author = "Gemini"
        description = "Detects JavaScript obfuscation patterns commonly used to hide second-stage payloads"
        date = "2026-02-13"
        score = 80
        fileType = "JAVASCRIPT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $s1 = "eval("
        $s2 = "String.fromCharCode"
        $s3 = "unescape("
        $s4 = "decodeURIComponent"
        $re_hex = /[0-9a-fA-F]{60,}/
    condition:
        (all of ($s1, $s2)) or
        (all of ($s1, $re_hex)) or
        (all of ($s1, $s3)) or
        (all of ($s1, $s4))
}


/*
 * Rule Name: MALICIOUS_JS_ActiveX_Dropper
 * Target: JavaScript Files
 * Technique: Using ActiveX objects (WScript/ADODB) to drop and execute files
 * False Positives: Legacy internal IE-based corporate tools
 */
rule MALICIOUS_JS_ActiveX_Dropper {
    meta:
        author = "Gemini"
        description = "Detects JS scripts using ActiveX to interact with the file system and download files"
        date = "2026-02-13"
        score = 90
        fileType = "JAVASCRIPT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $o1 = "ActiveXObject"
        $o2 = "WScript.Shell"
        $o3 = "ADODB.Stream"
        $o4 = "Scripting.FileSystemObject"
        $o5 = "MSXML2.XMLHTTP"
    condition:
        $o1 and (2 of ($o2, $o3, $o4, $o5))
}

// ============================================================================
// 5. POWERSHELL (2 Rules)
// ============================================================================

/*
 * Rule Name: BACKDOOR_PS_DownloadCradle
 * Target: PowerShell Scripts
 * Technique: One-liner download cradles using WebClient or Invoke-WebRequest
 * False Positives: Administrator automation scripts (check context)
 */
rule BACKDOOR_PS_DownloadCradle {
    meta:
        author = "Gemini"
        description = "Detects PowerShell download cradles used to fetch and execute remote code"
        date = "2026-02-13"
        score = 90
        fileType = "POWERSHELL"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $c1 = "Net.WebClient" nocase
        $c2 = "DownloadString" nocase
        $c3 = "DownloadFile" nocase
        $c4 = "Invoke-WebRequest" nocase
        $c5 = "Invoke-Expression" nocase
        $c6 = "IEX" nocase
        $b1 = "-ExecutionPolicy Bypass" nocase
        $b2 = "-enc" nocase // EncodedCommand
    condition:
        (any of ($c1, $c4)) and (any of ($c2, $c3, $c5, $c6)) and (any of ($b*))
}

/*
 * Rule Name: SUSPICIOUS_PS_ReflectionInjection
 * Target: PowerShell Scripts
 * Technique: Loading DLLs or Shellcode directly into memory via Reflection
 * False Positives: Advanced pentesting tools (Cobalt Strike, Metasploit)
 */
rule SUSPICIOUS_PS_ReflectionInjection {
    meta:
        author = "Gemini"
        description = "Detects PowerShell scripts performing memory injection or reflective assembly loading"
        date = "2026-02-13"
        score = 100
        fileType = "POWERSHELL"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $s1 = "Reflection.Assembly]::Load" nocase
        $s2 = "VirtualAlloc" nocase
        $s3 = "Marshal.Copy" nocase
        $s4 = "GetDelegateForFunctionPointer" nocase
        $s5 = "Add-Type" nocase
    condition:
        (3 of ($s*))
}/*
YARA Rules for Common Malware Detection 
Author: Generated for MP1 Malware Forensics Project: COPILOT
Date: 2026-02-13
Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
*/

import "pe"
import "math"

rule SUSPICIOUS_PE_Injections {
    meta:
        author = "Copilot"
        description = "Detects suspicious API imports and process injection in PE files"
        date = "2026-02-13"
        score = 95
        fileType = "PE_EXECUTABLE"
    strings:
        $magic = "MZ"
        $api1 = "VirtualAllocEx"
        $api2 = "CreateRemoteThread"
        $api3 = "WriteProcessMemory"
        $api4 = "SetWindowsHookEx"
    condition:
        $magic at 0 and
        pe.number_of_signatures == 0 and
        2 of ($api*)
}

rule SUSPICIOUS_PE_PackedSections {
    meta:
        author = "Copilot"
        description = "Detects packed or encrypted PE sections with suspicious names"
        date = "2026-02-13"
        score = 90
        fileType = "PE_EXECUTABLE"
    strings:
        $magic = "MZ"
        $sec1 = "UPX0"
        $sec2 = ".aspack"
        $sec3 = ".adata"
    condition:
        $magic at 0 and
        pe.number_of_signatures == 0 and
        any of ($sec*) and
        for any i in (0..pe.number_of_sections - 1): (
            pe.sections[i].name == "UPX0" or
            pe.sections[i].name == ".aspack" or
            pe.sections[i].name == ".adata" or
            (
                pe.sections[i].raw_data_size > 0 and
                math.entropy(
                    pe.sections[i].raw_data_offset,
                    pe.sections[i].raw_data_size
                ) > 7.5
            )
        )
}

rule SUSPICIOUS_PE_AntiDebug {
    meta:
        author = "Copilot"
        description = "Detects anti-debugging API usage in PE files"
        date = "2026-02-13"
        score = 85
        fileType = "PE_EXECUTABLE"
    strings:
        $magic = "MZ"
        $api1 = "IsDebuggerPresent"
        $api2 = "NtQueryInformationProcess"
        $api3 = "CheckRemoteDebuggerPresent"
    condition:
        $magic at 0 and
        pe.number_of_signatures == 0 and
        1 of ($api*)
}

rule MALICIOUS_PDF_JavaScript {
    meta:
        author = "Copilot"
        description = "Detects embedded JavaScript in PDF documents"
        date = "2026-02-13"
        score = 90
        fileType = "PDF_DOCUMENT"
    strings:
        $magic = "%PDF"
        $js1 = "/JavaScript"
        $js2 = "/JS"
        $js3 = "/OpenAction"
        $js4 = "/Launch"
    condition:
        $magic at 0 and
        2 of ($js*)
}

rule MALICIOUS_PDF_EmbeddedFiles {
    meta:
        author = "Copilot"
        description = "Detects embedded files and URI objects in PDF documents"
        date = "2026-02-13"
        score = 80
        fileType = "PDF_DOCUMENT"
    strings:
        $magic = "%PDF"
        $embed = "/EmbeddedFile"
        $uri = "/URI"
    condition:
        $magic at 0 and
        ($embed or $uri)
}

rule MALICIOUS_OFFICE_VBA {
    meta:
        author = "Copilot"
        description = "Detects auto-executing VBA macros in Office documents"
        date = "2026-02-13"
        score = 95
        fileType = "OFFICE_DOCUMENT"
    strings:
        $magic = "PK"
        $auto1 = "Auto_Open"
        $auto2 = "Document_Open"
        $auto3 = "Workbook_Open"
        $func1 = "CreateObject"
        $func2 = "WScript.Shell"
    condition:
        $magic at 0 and
        any of ($auto*) and
        any of ($func*)
}

rule MALICIOUS_OFFICE_PowerShell {
    meta:
        author = "Copilot"
        description = "Detects PowerShell execution from Office macros"
        date = "2026-02-13"
        score = 90
        fileType = "OFFICE_DOCUMENT"
    strings:
        $magic = "PK"
        $ps1 = "powershell.exe"
        $ps2 = "Shell"
        $ps3 = "URLDownloadToFile"
        $ps4 = "ADODB.Stream"
    condition:
        $magic at 0 and
        2 of ($ps*)
}

rule MALICIOUS_JS_Obfuscation {
    meta:
        author = "Copilot"
        description = "Detects obfuscation techniques in JavaScript files"
        date = "2026-02-13"
        score = 85
        fileType = "JAVASCRIPT_FILE"
    strings:
        $magic = "function"
        $obf1 = "eval("
        $obf2 = "unescape("
        $obf3 = "decodeURIComponent("
        $obf4 = "fromCharCode("
        $obf5 = "ActiveXObject"
    condition:
        $magic and 2 of ($obf*)
}

rule MALICIOUS_JS_EncodedPayloads {
    meta:
        author = "Copilot"
        description = "Detects long hex strings and encoded payloads in JavaScript"
        date = "2026-02-13"
        score = 80
        fileType = "JAVASCRIPT_FILE"
    strings:
        $magic = "function"
        $hex = /[0-9A-F]{100,}/ nocase
        $docwrite = "document.write("
    condition:
        $magic and ($hex or $docwrite)
}

rule MALICIOUS_PS_DownloadCradle {
    meta:
        author = "Copilot"
        description = "Detects PowerShell download cradle techniques"
        date = "2026-02-13"
        score = 95
        fileType = "POWERSHELL_SCRIPT"
    strings:
        $magic = "powershell"
        $dl1 = "System.Net.WebClient"
        $dl2 = "DownloadFile"
        $dl3 = "Invoke-WebRequest"
        $dl4 = "-EncodedCommand"
    condition:
        $magic and 2 of ($dl*)
}

rule MALICIOUS_PS_Obfuscation {
    meta:
        author = "Copilot"
        description = "Detects obfuscation and hidden execution in PowerShell scripts"
        date = "2026-02-13"
        score = 85
        fileType = "POWERSHELL_SCRIPT"
    strings:
        $magic = "powershell"
        $hide1 = "-WindowStyle Hidden"
        $hide2 = "-NoProfile"
        $hide3 = "Set-ExecutionPolicy"
        $hide4 = /[A-Za-z0-9+\/]{200,}={0,2}/
    condition:
        $magic and (any of ($hide1,$hide2,$hide3) or $hide4)
}
