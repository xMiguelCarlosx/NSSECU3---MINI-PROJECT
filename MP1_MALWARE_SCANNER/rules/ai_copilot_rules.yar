/*
YARA Rules for Common Malware Detection 
Author: Generated for MP1 Malware Forensics Project: COPILOT
Date: 2026-02-13
Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
*/

import "pe"
import "math"

rule SUSPICIOUS_PE_Injections {
    meta:
        author = "Copilot"
        description = "Detects suspicious API imports and process injection in PE files"
        date = "2026-02-13"
        score = 95
        fileType = "PE_EXECUTABLE"
    strings:
        $magic = "MZ"
        $api1 = "VirtualAllocEx"
        $api2 = "CreateRemoteThread"
        $api3 = "WriteProcessMemory"
        $api4 = "SetWindowsHookEx"
    condition:
        $magic at 0 and
        pe.number_of_signatures == 0 and
        2 of ($api*)
}

rule SUSPICIOUS_PE_PackedSections {
    meta:
        author = "Copilot"
        description = "Detects packed or encrypted PE sections with suspicious names"
        date = "2026-02-13"
        score = 90
        fileType = "PE_EXECUTABLE"
    strings:
        $magic = "MZ"
        $sec1 = "UPX0"
        $sec2 = ".aspack"
        $sec3 = ".adata"
    condition:
        $magic at 0 and
        pe.number_of_signatures == 0 and
        any of ($sec*) and
        for any i in (0..pe.number_of_sections - 1): (
            pe.sections[i].name == "UPX0" or
            pe.sections[i].name == ".aspack" or
            pe.sections[i].name == ".adata" or
            (
                pe.sections[i].raw_data_size > 0 and
                math.entropy(
                    pe.sections[i].raw_data_offset,
                    pe.sections[i].raw_data_size
                ) > 7.5
            )
        )
}

rule SUSPICIOUS_PE_AntiDebug {
    meta:
        author = "Copilot"
        description = "Detects anti-debugging API usage in PE files"
        date = "2026-02-13"
        score = 85
        fileType = "PE_EXECUTABLE"
    strings:
        $magic = "MZ"
        $api1 = "IsDebuggerPresent"
        $api2 = "NtQueryInformationProcess"
        $api3 = "CheckRemoteDebuggerPresent"
    condition:
        $magic at 0 and
        pe.number_of_signatures == 0 and
        1 of ($api*)
}

rule MALICIOUS_PDF_JavaScript {
    meta:
        author = "Copilot"
        description = "Detects embedded JavaScript in PDF documents"
        date = "2026-02-13"
        score = 90
        fileType = "PDF_DOCUMENT"
    strings:
        $magic = "%PDF"
        $js1 = "/JavaScript"
        $js2 = "/JS"
        $js3 = "/OpenAction"
        $js4 = "/Launch"
    condition:
        $magic at 0 and
        2 of ($js*)
}

rule MALICIOUS_PDF_EmbeddedFiles {
    meta:
        author = "Copilot"
        description = "Detects embedded files and URI objects in PDF documents"
        date = "2026-02-13"
        score = 80
        fileType = "PDF_DOCUMENT"
    strings:
        $magic = "%PDF"
        $embed = "/EmbeddedFile"
        $uri = "/URI"
    condition:
        $magic at 0 and
        ($embed or $uri)
}

rule MALICIOUS_OFFICE_VBA {
    meta:
        author = "Copilot"
        description = "Detects auto-executing VBA macros in Office documents"
        date = "2026-02-13"
        score = 95
        fileType = "OFFICE_DOCUMENT"
    strings:
        $magic = "PK"
        $auto1 = "Auto_Open"
        $auto2 = "Document_Open"
        $auto3 = "Workbook_Open"
        $func1 = "CreateObject"
        $func2 = "WScript.Shell"
    condition:
        $magic at 0 and
        any of ($auto*) and
        any of ($func*)
}

rule MALICIOUS_OFFICE_PowerShell {
    meta:
        author = "Copilot"
        description = "Detects PowerShell execution from Office macros"
        date = "2026-02-13"
        score = 90
        fileType = "OFFICE_DOCUMENT"
    strings:
        $magic = "PK"
        $ps1 = "powershell.exe"
        $ps2 = "Shell"
        $ps3 = "URLDownloadToFile"
        $ps4 = "ADODB.Stream"
    condition:
        $magic at 0 and
        2 of ($ps*)
}

rule MALICIOUS_JS_Obfuscation {
    meta:
        author = "Copilot"
        description = "Detects obfuscation techniques in JavaScript files"
        date = "2026-02-13"
        score = 85
        fileType = "JAVASCRIPT_FILE"
    strings:
        $magic = "function"
        $obf1 = "eval("
        $obf2 = "unescape("
        $obf3 = "decodeURIComponent("
        $obf4 = "fromCharCode("
        $obf5 = "ActiveXObject"
    condition:
        $magic and 2 of ($obf*)
}

rule MALICIOUS_JS_EncodedPayloads {
    meta:
        author = "Copilot"
        description = "Detects long hex strings and encoded payloads in JavaScript"
        date = "2026-02-13"
        score = 80
        fileType = "JAVASCRIPT_FILE"
    strings:
        $magic = "function"
        $hex = /[0-9A-F]{100,}/ nocase
        $docwrite = "document.write("
    condition:
        $magic and ($hex or $docwrite)
}

rule MALICIOUS_PS_DownloadCradle {
    meta:
        author = "Copilot"
        description = "Detects PowerShell download cradle techniques"
        date = "2026-02-13"
        score = 95
        fileType = "POWERSHELL_SCRIPT"
    strings:
        $magic = "powershell"
        $dl1 = "System.Net.WebClient"
        $dl2 = "DownloadFile"
        $dl3 = "Invoke-WebRequest"
        $dl4 = "-EncodedCommand"
    condition:
        $magic and 2 of ($dl*)
}

rule MALICIOUS_PS_Obfuscation {
    meta:
        author = "Copilot"
        description = "Detects obfuscation and hidden execution in PowerShell scripts"
        date = "2026-02-13"
        score = 85
        fileType = "POWERSHELL_SCRIPT"
    strings:
        $magic = "powershell"
        $hide1 = "-WindowStyle Hidden"
        $hide2 = "-NoProfile"
        $hide3 = "Set-ExecutionPolicy"
        $hide4 = /[A-Za-z0-9+\/]{200,}={0,2}/
    condition:
        $magic and (any of ($hide1,$hide2,$hide3) or $hide4)
}
