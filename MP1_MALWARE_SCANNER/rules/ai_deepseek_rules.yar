/*
YARA Rules for Common Malware Detection 
Author: Generated for MP1 Malware Forensics Project: DEEPSEEK
Date: 2026-02-13
Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
*/

import "pe"
import "math"

rule SUSPICIOUS_PE_HighEntropy_Sections
{
    meta:
        author = "deepseek"
        description = "Detects PE files with high entropy sections (potential packed/encrypted malware)"
        date = "2026-02-13"
        score = 85
        fileType = "PE_EXECUTABLE"
    
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and
        (
            (
                for any i in (0..pe.number_of_sections - 1) :
                    (
                        (pe.sections[i].name == ".text" or
                         pe.sections[i].name == "UPX0" or
                         pe.sections[i].name == ".aspack") and
                        pe.sections[i].raw_data_size > 0 and
                        math.entropy(
                            pe.sections[i].raw_data_offset,
                            pe.sections[i].raw_data_size
                        ) > 6.8
                    )
            )
            or
            (
                for any i in (0..pe.number_of_sections - 1) :
                    (
                        pe.sections[i].name == ".upx0" or
                        pe.sections[i].name == ".aspack" or
                        pe.sections[i].name == ".adata" or
                        pe.sections[i].name == "PACKED"
                    )
            )
            or
            (
                for any i in (0..pe.number_of_sections - 1) :
                    (
                        pe.sections[i].characteristics & pe.SECTION_MEM_WRITE and
                        pe.sections[i].characteristics & pe.SECTION_MEM_EXECUTE
                    )
            )
        ) and
        not pe.is_signed and
        pe.number_of_signatures == 0
}



rule MALICIOUS_PDF_JavaScript_Objects
{
    meta:
        author = "deepseek"
        description = "Detects PDF files containing JavaScript objects (potential malicious PDF)"
        date = "2026-02-13"
        score = 90
        fileType = "PDF_DOCUMENT"
    
    strings:
        $magic = { 25 50 44 46 }
        $js1 = "/JavaScript" nocase
        $js2 = "/JS" nocase
        $launch = "/Launch" nocase
        $embedded = "/EmbeddedFile" nocase
        $openaction = "/OpenAction" nocase
        $uri = "/URI" nocase
        
    condition:
        $magic at 0 and
        ($js1 or $js2) and
        ($launch or $embedded or $openaction or $uri) and
        filesize < 10MB
}



rule MALICIOUS_PDF_Exploit_Strings
{
    meta:
        author = "deepseek"
        description = "Detects PDF files with exploit-related strings"
        date = "2026-02-13"
        score = 85
        fileType = "PDF_DOCUMENT"
    
    strings:
        $magic = { 25 50 44 46 }
        $heapspray1 = "/UI" nocase
        $heapspray2 = "/Collab" nocase
        $collab = "/Collab.getIcon" nocase
        $util = "app.util" nocase
        $eval = "eval(" nocase ascii
        $ek1 = "/BlackHole" nocase
        $ek2 = "/Angler" nocase
        $ek3 = "/Nuclear" nocase
        $shellcode1 = { 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? E8 ?? ?? ?? ?? }
        $shellcode2 = { 31 C9 64 8B 71 30 }
        
    condition:
        $magic at 0 and
        (
            $heapspray1 or $heapspray2 or
            ($collab and $util) or
            $eval or
            $ek1 or $ek2 or $ek3 or
            $shellcode1 or $shellcode2
        )
}

rule MALICIOUS_OFFICE_Macros_VBA
{
    meta:
        author = "deepseek"
        description = "Detects Office documents with VBA macros (potential malware)"
        date = "2026-02-13"
        score = 95
        fileType = "OFFICE_DOCUMENT"
    
    strings:
        $ole_magic = { D0 CF 11 E0 A1 B1 1A E1 }
        $zip_magic = { 50 4B 03 04 }
        $vba1 = "VBA" nocase
        $vba2 = "Module=" nocase
        $shell = "Shell(" nocase ascii
        $createobject = "CreateObject(" nocase ascii
        $wscript = "WScript.Shell" nocase ascii
        $powershell = "PowerShell" nocase ascii
        $cmd = "cmd.exe" nocase ascii
        $download = "URLDownloadToFile" nocase ascii
        $xmlhttp = "XMLHTTP" nocase ascii
        $adodb = "ADODB.Stream" nocase ascii
        $auto_open = "Auto_Open" nocase ascii
        $auto_close = "Auto_Close" nocase ascii
        $document_open = "Document_Open" nocase ascii
        $workbook_open = "Workbook_Open" nocase ascii
        
    condition:
        ($ole_magic at 0 or $zip_magic at 0) and
        ($vba1 or $vba2) and
        (
            $shell or $createobject or $wscript or
            $powershell or $cmd or $download or
            $xmlhttp or $adodb
        ) and
        ($auto_open or $auto_close or $document_open or $workbook_open)
}

rule MALICIOUS_JavaScript_Obfuscated
{
    meta:
        author = "deepseek"
        description = "Detects obfuscated/deobfuscation patterns in JavaScript"
        date = "2026-02-13"
        score = 85
        fileType = "JAVASCRIPT"
    
    strings:
        $eval = "eval(" nocase ascii
        $document_write = "document.write(" nocase ascii
        $unescape = "unescape(" nocase ascii
        $decodeuri = "decodeURIComponent(" nocase ascii
        $fromcharcode = "String.fromCharCode(" nocase ascii
        $replace = ".replace(" nocase ascii
        $long_hex = /[0-9a-fA-F]{40,}/
        $long_num = /[0-9]{50,}/
        $activex = "ActiveXObject" nocase ascii
        $wscript = "WScript" nocase ascii
        $adodb = "ADODB" nocase ascii
        $xmlhttp = "XMLHttpRequest" nocase ascii
        
    condition:
        filesize < 1MB and
        (
            (
                ($eval or $document_write) and
                ($unescape or $decodeuri or $fromcharcode) and
                (#long_hex > 1 or #long_num > 1)
            ) or
            (
                ($activex or $wscript or $adodb or $xmlhttp) and
                ($eval or $unescape or $fromcharcode)
            )
        ) and
        any of ($replace)
}

rule MALICIOUS_PowerShell_Suspicious_Commands
{
    meta:
        author = "deepseek"
        description = "Detects suspicious PowerShell commands used by malware"
        date = "2026-02-13"
        score = 90
        fileType = "POWERSHELL_SCRIPT"
    
    strings:
        $ep_bypass1 = "-ExecutionPolicy Bypass" nocase ascii
        $ep_bypass2 = "Set-ExecutionPolicy" nocase ascii
        $hidden1 = "-WindowStyle Hidden" nocase ascii
        $hidden2 = "-WindowsStyle Hidden" nocase ascii
        $hidden3 = "-NoProfile" nocase ascii
        $download1 = "System.Net.WebClient" nocase ascii
        $download2 = "DownloadFile(" nocase ascii
        $download3 = "DownloadString(" nocase ascii
        $download4 = "Invoke-WebRequest" nocase ascii
        $download5 = "Invoke-RestMethod" nocase ascii
        $b64_flag1 = "-EncodedCommand" nocase ascii
        $b64_flag2 = "-enc" nocase ascii
        $reflection1 = "Add-Type" nocase ascii
        $backtick = "`" ascii
        $replace_ops = ".Replace(" nocase ascii
        
    condition:
        (
            ($ep_bypass1 or $ep_bypass2) and
            ($hidden1 or $hidden2 or $hidden3) and
            ($download1 or $download2 or $download3 or $download4 or $download5)
        ) or
        $b64_flag1 or $b64_flag2 or
        $reflection1 or
        (#backtick > 10 and $replace_ops)
}

rule MALICIOUS_Backdoor_Persistence
{
    meta:
        author = "deepseek"
        description = "Detects common backdoor persistence mechanisms"
        date = "2026-02-13"
        score = 90
        fileType = "VARIOUS"
    
    strings:
        $reg_run1 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $reg_run2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $reg_run3 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $schtasks1 = "schtasks" nocase ascii
        $schtasks2 = "/create" nocase ascii
        $schtasks3 = "/sc daily" nocase ascii
        $schtasks4 = "/sc onlogon" nocase ascii
        $startup1 = "Startup" nocase ascii
        $startup2 = "All Users\\Start Menu\\Programs\\Startup" nocase ascii
        $service1 = "CreateService" nocase ascii
        $service2 = "sc.exe create" nocase ascii
        $service3 = "New-Service" nocase ascii
        $c2_http = "http://" nocase ascii
        $c2_https = "https://" nocase ascii
        $c2_post = "POST" nocase ascii
        $c2_get = "GET" nocase ascii
        $cmd_shell = "cmd.exe /c" nocase ascii
        $ps_shell = "powershell.exe" nocase ascii
        
    condition:
        $reg_run1 or $reg_run2 or $reg_run3 or
        ($schtasks1 and ($schtasks2 or $schtasks3 or $schtasks4)) or
        $startup1 or $startup2 or
        $service1 or $service2 or $service3 or
        $c2_http or $c2_https or $c2_post or $c2_get or
        $cmd_shell or $ps_shell or
        (($c2_http or $c2_https or $c2_post or $c2_get) and
         ($reg_run1 or $reg_run2 or $schtasks1 or $startup1))
}

rule MALICIOUS_Generic_Suspicious_Strings
{
    meta:
        author = "deepseek"
        description = "Detects generic suspicious strings commonly found in malware"
        date = "2026-02-13"
        score = 70
        fileType = "VARIOUS"
    
    strings:
        $s1 = "MALWARE" nocase ascii wide
        $s2 = "BACKDOOR" nocase ascii wide
        $s3 = "RAT" nocase ascii wide
        $s4 = "DROPPER" nocase ascii wide
        $s5 = "PAYLOAD" nocase ascii wide
        $s6 = "EXPLOIT" nocase ascii wide
        $s7 = "CRYPT" nocase ascii wide
        $s8 = "INJECT" nocase ascii wide
        $s9 = "KEYLOG" nocase ascii wide
        $s10 = "PASSWORD STEALER" nocase ascii wide
        $s11 = "BYPASS" nocase ascii wide
        $s12 = "PRIVILEGE ESCALATION" nocase ascii wide
        
    condition:
        2 of ($s*)
}
