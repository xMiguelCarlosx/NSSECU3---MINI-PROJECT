/*
YARA Rules for Common Malware Detection 
Author: Generated for MP1 Malware Forensics Project: GEMINI
Date: 2026-02-13
Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
*/

import "pe"
import "math"

// ============================================================================
// 1. PE EXECUTABLES (4 Rules)
// ============================================================================

/*
 * Rule Name: SUSPICIOUS_PE_KnownPackerSections
 * Target: Windows PE Executables
 * Technique: Identification of non-standard section names used by packers/protectors
 * False Positives: Rare, as these names are specific to packing tools
 */
rule SUSPICIOUS_PE_KnownPackerSections {
    meta:
        author = "Gemini"
        description = "Detects PE files using known packer section names like UPX, ASPack, and VMProtect"
        date = "2026-02-13"
        score = 85
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        // Section names are typically 8 bytes, null-padded
        $s1 = "UPX0"
        $s2 = "UPX1"
        $s3 = ".aspack"
        $s4 = ".adata"
        $s5 = ".vmp0"
        $s6 = ".vmp1"
        $s7 = ".enigma"
        $s8 = ".petite"
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and
        any of ($s*)
}

/*
 * Rule Name: SUSPICIOUS_PE_HighEntropySections
 * Target: Windows PE Executables
 * Technique: Entropy analysis to find encrypted or compressed code/data
 * False Positives: Heavily compressed legitimate installers or game assets
 */
rule SUSPICIOUS_PE_HighEntropySections {
    meta:
        author = "Gemini"
        description = "Detects PE files with sections exceeding entropy thresholds (indicative of packing/encryption)"
        date = "2026-02-13"
        score = 80
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and pe.number_of_signatures == 0 and
        /* Iterate through sections to check entropy.
           Entropy > 7.5 is a strong indicator of encryption/packing.
        */
        for any i in (0..pe.number_of_sections - 1): (
            math.entropy(pe.sections[i].raw_data_offset, pe.sections[i].raw_data_size) > 7.5
        )
}

/*
 * Rule Name: SUSPICIOUS_PE_ProcessInjection_APIs
 * Target: Windows PE Executables
 * Technique: Core APIs used for Cross-Process Memory Injection
 * False Positives: Debuggers, Security software, specialized system utilities
 */
rule SUSPICIOUS_PE_ProcessInjection_APIs {
    meta:
        author = "Gemini"
        description = "Detects combination of APIs used to inject code into remote processes"
        date = "2026-02-13"
        score = 90
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $api1 = "VirtualAllocEx"
        $api2 = "WriteProcessMemory"
        $api3 = "CreateRemoteThread"
        $api4 = "NtCreateThreadEx"
        $api5 = "QueueUserAPC"
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and pe.number_of_signatures == 0 and
        (3 of ($api*))
}

/*
 * Rule Name: SUSPICIOUS_PE_PersistenceAndEvasion
 * Target: Windows PE Executables
 * Technique: Registry persistence combined with anti-debugging checks
 * False Positives: Monitoring tools or complex legitimate software protections
 */
rule SUSPICIOUS_PE_PersistenceAndEvasion {
    meta:
        author = "Gemini"
        description = "Detects persistence mechanisms combined with anti-forensic evasion APIs"
        date = "2026-02-13"
        score = 75
        fileType = "PE_EXECUTABLE"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $reg1 = "RegSetValueEx"
        $reg2 = "RegCreateKeyEx"
        $eva1 = "IsDebuggerPresent"
        $eva2 = "NtQueryInformationProcess"
        $eva3 = "CheckRemoteDebuggerPresent"
        $sch1 = "schtasks.exe" wide ascii
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and
        (
            (any of ($reg*)) or $sch1
        ) and
        (any of ($eva*)) and
        pe.number_of_signatures == 0
}


// ============================================================================
// 2. PDF DOCUMENTS (2 Rules)
// ============================================================================

/*
 * Rule Name: MALICIOUS_PDF_JavaScriptExecution
 * Target: PDF Documents
 * Technique: Automatic execution of JavaScript upon opening the document
 * False Positives: Interactive PDF forms
 */
rule MALICIOUS_PDF_JavaScriptExecution {
    meta:
        author = "Gemini"
        description = "Detects PDF files that contain both JavaScript and Auto-Open actions"
        date = "2026-02-13"
        score = 85
        fileType = "PDF_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $magic = { 25 50 44 46 } // %PDF
        $s1 = "/JavaScript"
        $s2 = "/JS"
        $s3 = "/OpenAction"
        $s4 = "/AcroForm"
    condition:
        $magic at 0 and (all of ($s1, $s2, $s3) or all of ($s2, $s3, $s4))
}

/*
 * Rule Name: MALICIOUS_PDF_EmbeddedExploit
 * Target: PDF Documents
 * Technique: Embedding malicious files or using Launch actions for execution
 * False Positives: Complex portfolio PDFs
 */
rule MALICIOUS_PDF_EmbeddedExploit {
    meta:
        author = "Gemini"
        description = "Detects high-risk PDF tags used for embedding and launching external payloads"
        date = "2026-02-13"
        score = 90
        fileType = "PDF_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $magic = { 25 50 44 46 }
        $e1 = "/EmbeddedFile"
        $e2 = "/Launch"
        $e3 = "/URI"
        $e4 = "unescape" // Often used in heap sprays within PDF JS
    condition:
        $magic at 0 and 2 of ($e*) and filesize < 10MB
}

// ============================================================================
// 3. OFFICE DOCUMENTS (2 Rules)
// ============================================================================

/*
 * Rule Name: TROJAN_Office_AutoExecMacro
 * Target: Office Documents (.doc, .xls, .docx, .xlsx)
 * Technique: VBA macros that execute automatically to run malicious commands
 * False Positives: Corporate documents with legitimate automation
 */
rule TROJAN_Office_AutoExecMacro {
    meta:
        author = "Gemini"
        description = "Detects Office documents with VBA macros that auto-execute on opening"
        date = "2026-02-13"
        score = 85
        fileType = "OFFICE_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $magic_ooxml = { 50 4B 03 04 } // ZIP-based (Docx, Xlsx)
        $magic_ole = { D0 CF 11 E0 }   // OLE-based (Doc, Xls)

        $a1 = "Auto_Open"
        $a2 = "Document_Open"
        $a3 = "Workbook_Open"

        $s1 = "WScript.Shell"
        $s2 = "CreateObject"
        $s3 = "Shell.Application"

    condition:
        ($magic_ooxml at 0 or $magic_ole at 0) and
        (any of ($a*)) and (any of ($s*))
}

/*
 * Rule Name: MALICIOUS_Office_PowerShellDownload
 * Target: Office Documents
 * Technique: VBA macro launching PowerShell to download a payload
 * False Positives: Extremely rare in legitimate business contexts
 */
rule MALICIOUS_Office_PowerShellDownload {
    meta:
        author = "Gemini"
        description = "Detects Office macros calling PowerShell with download and bypass flags"
        date = "2026-02-13"
        score = 95
        fileType = "OFFICE_DOCUMENT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $p1 = "powershell.exe" ascii wide
        $p2 = "-ExecutionPolicy Bypass" ascii wide
        $p3 = "-WindowStyle Hidden" ascii wide
        $p4 = "URLDownloadToFile" ascii wide
        $p5 = "MSXML2.XMLHTTP" ascii wide
    condition:
        (uint32(0) == 0x04034B50 or uint32(0) == 0xE11AB1D0) and
        (any of ($p1, $p2, $p3)) and (any of ($p4, $p5))
}

// ============================================================================
// 4. JAVASCRIPT (2 Rules)
// ============================================================================

/*
 * Rule Name: OBFUSCATED_JS_EvalWithFromCharCode
 * Target: JavaScript Files
 * Technique: Use of eval and fromCharCode to hide malicious script logic
 * False Positives: Minified or protected legitimate JS libraries
 */
rule OBFUSCATED_JS_EvalWithFromCharCode {
    meta:
        author = "Gemini"
        description = "Detects JavaScript obfuscation patterns commonly used to hide second-stage payloads"
        date = "2026-02-13"
        score = 80
        fileType = "JAVASCRIPT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $s1 = "eval("
        $s2 = "String.fromCharCode"
        $s3 = "unescape("
        $s4 = "decodeURIComponent"
        $re_hex = /[0-9a-fA-F]{60,}/
    condition:
        (all of ($s1, $s2)) or
        (all of ($s1, $re_hex)) or
        (all of ($s1, $s3)) or
        (all of ($s1, $s4))
}


/*
 * Rule Name: MALICIOUS_JS_ActiveX_Dropper
 * Target: JavaScript Files
 * Technique: Using ActiveX objects (WScript/ADODB) to drop and execute files
 * False Positives: Legacy internal IE-based corporate tools
 */
rule MALICIOUS_JS_ActiveX_Dropper {
    meta:
        author = "Gemini"
        description = "Detects JS scripts using ActiveX to interact with the file system and download files"
        date = "2026-02-13"
        score = 90
        fileType = "JAVASCRIPT"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $o1 = "ActiveXObject"
        $o2 = "WScript.Shell"
        $o3 = "ADODB.Stream"
        $o4 = "Scripting.FileSystemObject"
        $o5 = "MSXML2.XMLHTTP"
    condition:
        $o1 and (2 of ($o2, $o3, $o4, $o5))
}

// ============================================================================
// 5. POWERSHELL (2 Rules)
// ============================================================================

/*
 * Rule Name: BACKDOOR_PS_DownloadCradle
 * Target: PowerShell Scripts
 * Technique: One-liner download cradles using WebClient or Invoke-WebRequest
 * False Positives: Administrator automation scripts (check context)
 */
rule BACKDOOR_PS_DownloadCradle {
    meta:
        author = "Gemini"
        description = "Detects PowerShell download cradles used to fetch and execute remote code"
        date = "2026-02-13"
        score = 90
        fileType = "POWERSHELL"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $c1 = "Net.WebClient" nocase
        $c2 = "DownloadString" nocase
        $c3 = "DownloadFile" nocase
        $c4 = "Invoke-WebRequest" nocase
        $c5 = "Invoke-Expression" nocase
        $c6 = "IEX" nocase
        $b1 = "-ExecutionPolicy Bypass" nocase
        $b2 = "-enc" nocase // EncodedCommand
    condition:
        (any of ($c1, $c4)) and (any of ($c2, $c3, $c5, $c6)) and (any of ($b*))
}

/*
 * Rule Name: SUSPICIOUS_PS_ReflectionInjection
 * Target: PowerShell Scripts
 * Technique: Loading DLLs or Shellcode directly into memory via Reflection
 * False Positives: Advanced pentesting tools (Cobalt Strike, Metasploit)
 */
rule SUSPICIOUS_PS_ReflectionInjection {
    meta:
        author = "Gemini"
        description = "Detects PowerShell scripts performing memory injection or reflective assembly loading"
        date = "2026-02-13"
        score = 100
        fileType = "POWERSHELL"
        reference = "MP1 Malware Forensics Project - Gemini AI Comparison"
    strings:
        $s1 = "Reflection.Assembly]::Load" nocase
        $s2 = "VirtualAlloc" nocase
        $s3 = "Marshal.Copy" nocase
        $s4 = "GetDelegateForFunctionPointer" nocase
        $s5 = "Add-Type" nocase
    condition:
        (3 of ($s*))
}