"""
Quarantine management for suspicious files.
Copies files with .quarantine extension as specified.
"""
from typing import List
import shutil
from pathlib import Path
from datetime import datetime
import logging

logger = logging.getLogger(__name__)

class QuarantineManager:
    """Handle file quarantine operations."""
    
    def __init__(self, quarantine_root: Path):
        """
        Initialize quarantine manager.
        
        Args:
            quarantine_root: Base directory for quarantine
        """
        self.quarantine_root = Path(quarantine_root)
        self.quarantine_root.mkdir(parents=True, exist_ok=True)
    
    def quarantine_file(self, 
                       file_path: Path, 
                       rule_names: List[str],
                       md5_hash: str) -> Path:
        """
        Move file to quarantine with metadata.
        
        Args:
            file_path: Original file path
            rule_names: YARA rules that matched
            md5_hash: MD5 hash for unique naming
            
        Returns:
            Path to quarantined file
        """
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # Create quarantine filename with .quarantine extension
        original_name = file_path.name
        quarantine_name = f"{original_name}_{md5_hash[:8]}_{timestamp}.quarantine"
        quarantine_path = self.quarantine_root / quarantine_name
        
        try:
            # Copy file to quarantine (preserve original per forensics best practice)
            shutil.copy2(file_path, quarantine_path)
            
            # Write metadata file
            meta_path = quarantine_path.with_suffix('.meta')
            with open(meta_path, 'w') as f:
                f.write(f"Original Path: {file_path}\n")
                f.write(f"Quarantined: {timestamp}\n")
                f.write(f"YARA Rules: {', '.join(rule_names)}\n")
                f.write(f"MD5: {md5_hash}\n")
            
            logger.info(f"Quarantined: {file_path} -> {quarantine_path}")
            return quarantine_path
            
        except Exception as e:
            logger.error(f"Quarantine failed {file_path}: {e}")
            raise